<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>实现一个简单的Virtual DOM | 追客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/blog/favicon.ico">
  <link rel="stylesheet" href="/blog/css/app.css" type="text/css">
  <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'>
</head>

<body>
  <nav class="app-nav">
  <a href="/blog/about">about</a>
  <a href="/blog/archives">archive</a>
  <a class="home" href="/blog/.">home</a>
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/blog/2016/01/28/Virtual-DOM/">实现一个简单的Virtual DOM</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">January 28 2016</p>
  </section>

  <section class="article-entry">
    <p>最近实现了一个简单版的<a href="https://github.com/DrakeLeung/little-virtual-DOM" target="_blank" rel="external">Virtual DOM</a>。<br>之所以简单，是因为并没有实现React的diff算法，不过我们还是可以了解一下Virtual DOM。</p>
<h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p><em>Virtual DOM</em> 其实就是用JS对象去表示DOM元素。<br><img src="/blog/2016/01/28/Virtual-DOM/vdom0.png" alt="vdom0.png" title=""></p>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h2><p>为什么要Virtual DOM呢？因为DOM的操作本身是很慢的。但更慢的是批量操作时的不当。</p>
<p>比如，我们要添加5个<code>&lt;li&gt;</code>：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> appendElement =</span><br><span class="line">  type =&gt;</span><br><span class="line">    () =&gt;</span><br><span class="line">      <span class="built_in">document</span>.body.appendChild(<span class="built_in">document</span>.createElement(type))</span><br><span class="line"></span><br><span class="line"><span class="built_in">Array</span>.from(<span class="built_in">Array</span>(<span class="number">5</span>)).forEach(appendElement(<span class="string">'li'</span>))</span><br></pre></td></tr></table></figure></p>
<p>上面每次生成一个<code>li</code>就插入，这样是很慢的。正确的做法应该是先生成5个<code>li</code>，然后再一次性把这个5个<code>li</code>插入。这个过程，我们就可以使用Virtual DOM来实现。</p>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><p>总共分4个步骤，如下图所示：<br><img src="/blog/2016/01/28/Virtual-DOM/vdom2.png" alt="vdom2.png" title=""></p>
<h3 id="VNode"><a href="#VNode" class="headerlink" title="VNode"></a>VNode</h3><p><code>VNode</code>这个函数是用JavaScript对象来表示DOM元素，比如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">li</span> <span class="attribute">id</span>=<span class="value">"item1"</span>&gt;</span>Call Me Item 1<span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以表示为:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type: <span class="string">'li'</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    id: <span class="string">'item1'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  children: [<span class="string">'item1'</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，<code>props</code>可以是数组，<code>children</code> 也可以放在<code>props</code>里面。</p>
<h3 id="toHTML"><a href="#toHTML" class="headerlink" title="toHTML"></a>toHTML</h3><p>这个就是把<code>VNode</code>转化成真正的DOM元素。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 大体分3步</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 1: createElement</span></span><br><span class="line"><span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(type)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 2: set props</span></span><br><span class="line"><span class="built_in">Object</span>.keys(props).forEach(prop =&gt; &#123;</span><br><span class="line">  node.setAttribute(prop, props[prop])</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 3: set children</span></span><br><span class="line">children.forEach(VChild =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> childNode</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if text</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> VChild === <span class="string">'string'</span>) &#123;  <span class="comment">// #0</span></span><br><span class="line">    childNode = <span class="built_in">document</span>.createTextNode(VChild)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    childNode = createNode(VChild)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  node.appendChild(childNode)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> node</span><br></pre></td></tr></table></figure>
<p>在<code>#0</code>中，如果当前node是<code>string</code>的话，就表明是<code>text</code>。否则进行递归。</p>
<h3 id="Diff"><a href="#Diff" class="headerlink" title="Diff"></a>Diff</h3><p><code>diff</code>需要把新的Virtual DOM和旧的进行比较，从而得到变化的地方。<br>这个过程最难的了。我没用实现React的diff算法，只是对同级元素进行了比较而已。</p>
<p>主要有不同的4种情况:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> TEXT = <span class="string">'TEXT'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PROPS = <span class="string">'PROPS'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> REPLACE = <span class="string">'REPLACE'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ADD_CHILD = <span class="string">'ADD_CHILD'</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>TEXT</code>: 替换旧的<code>text</code></li>
<li><code>PROPS</code>: 表明<code>props</code>可能是增加，删除或修改</li>
<li><code>REPLACE</code>: 替换旧的节点，包括删除的</li>
<li><code>ADD_CHILD</code>: 表示需要增加child</li>
</ul>
<p>实现过程不讲述，详细看源代码(<a href="https://github.com/DrakeLeung/little-virtual-DOM/blob/master/src%2Fdiff.js" target="_blank" rel="external">diff</a>)</p>
<h3 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h3><p>这个过程把上个步骤得到的<code>diff</code>来给当前的DOM节点进行操作。这个过程就是我们优化DOM操作的地方。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> applyPatch = (node, currentPatch) =&gt; &#123;</span><br><span class="line">  <span class="keyword">switch</span> (currentPatch.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> patchType.TEXT:</span><br><span class="line">      node.nodeValue = currentPatch.content</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> patchType.PROPS:</span><br><span class="line">      setProps(node, currentPatch.props)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> patchType.REPLACE:</span><br><span class="line">      <span class="keyword">if</span> (isExist(currentPatch.node)) &#123;</span><br><span class="line">        node.parentNode.replaceChild(toHTML(currentPatch.node), node)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node.parentNode.removeChild(node)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> patchType.ADD_CHILD:</span><br><span class="line">      node.appendChild(toHTML(currentPatch.node))</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Wrap_up"><a href="#Wrap_up" class="headerlink" title="Wrap up"></a>Wrap up</h2><p>从实现这个简单的Virtual DOM，思路确实是打开了不少。</p>
<ul>
<li>用JavaScript对象来表示DOM元素。之前只会直接操作DOM，没有想到可以这样玩。</li>
<li>怎么比较2棵树的不同？只需要比较同级的元素。虽然还是不会比较children</li>
<li>复习了DOM的一些知识。</li>
</ul>
<p>所以<strong>多尝试</strong>不同的东西，思路会扩展不少~</p>
<h2 id="Resource"><a href="#Resource" class="headerlink" title="Resource"></a>Resource</h2><ul>
<li><a href="https://gist.github.com/sebmarkbage/fcb1b6ab493b0c77d589" target="_blank" rel="external">React (Virtual) DOM Terminology</a></li>
<li><a href="https://gcanti.github.io/2014/10/29/understanding-react-and-reimplementing-it-from-scratch-part-1.html" target="_blank" rel="external">Understanding-react-and-reimplementing-it-from-scratch-part-1</a></li>
<li><a href="https://www.zhihu.com/question/29504639" target="_blank" rel="external">怎么更好地理解虚拟DOM</a></li>
<li><a href="https://github.com/livoras/blog/issues/13" target="_blank" rel="external">如何实现一个Virtual DOM算法</a></li>
</ul>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="/blog/images/avatar.png" alt="avatar" />
    <div class="grid-item">
      <p class="title"> 追客 </p>
      <p class="subtitle"> 热爱生活，热爱编程，Web前端见习魔法师 </p>
    <div>
  </section>

  <section class="share-btns">
    <p> share it if you like it~ </p>
    <!-- <a
  class="twitter-share-button"
  data-size="large"
  data-via="DrakeLeung"
  href="https://twitter.com/intent/tweet?text=最近实现了一个简单版的<a href=""
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>
 -->
  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'drakeleung';
  
  var disqus_url = 'http://drakeleung.github.io/blog/2016/01/28/Virtual-DOM/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>

</body>
</html>
