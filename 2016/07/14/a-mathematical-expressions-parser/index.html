<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>A Mathematical Expressions Parser | ly你个c</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css" type="text/css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
</head>

<body>
  <nav class="app-nav">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives">archive</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2016/07/14/a-mathematical-expressions-parser/">A Mathematical Expressions Parser</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">July 14 2016</p>
  </section>

  <section class="article-entry">
    <p>更多信息可查看 <a href="http://drakeleung.github.io/demo/slides/calc">SLIDE</a> 。</p>
<h2 id="u95EE_u9898"><a href="#u95EE_u9898" class="headerlink" title="问题"></a>问题</h2><p>我们的问题是这样子的：</p>
<blockquote>
<p>写一个 <code>calculate</code> 函数，他的参数是一个四则运算表达式字符串，返回结果则是该参数的求值。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">calculate(<span class="string">'1+2*3'</span>) <span class="comment">// 7</span></span><br><span class="line">calculate(<span class="string">'1*(2+3)*4)'</span>) <span class="comment">// 20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * 规则：</span><br><span class="line"> * 1. 禁止 eval 及其类似物</span><br><span class="line"> * 2. 禁止第三方库</span><br><span class="line"> */</span></span><br></pre></td></tr></table></figure>
<h2 id="u6700_u7B80_u5355_u7684_u601D_u8DEF"><a href="#u6700_u7B80_u5355_u7684_u601D_u8DEF" class="headerlink" title="最简单的思路"></a>最简单的思路</h2><p>假设字符串就是简单的 <code>1+2</code>，那么最简单的想法当然是：</p>
<blockquote>
<p>遍历该字符串，然后根据不同的操作符，计算其结果，重复之。</p>
</blockquote>
<p>然而，当字符串为 <code>1+2*3</code> 时，得到的结果是 <code>9</code> 而不是 <code>7</code> 。这是因为我们并没有考虑到<strong>操作符的优先级</strong>。并且，如果加上括号（<code>()</code>）的话，那么优先级就变得更加复杂。</p>
<p>所以啊，我们就想：</p>
<blockquote>
<p>能不能没有优先级，按顺序就好啦，这样就简单多了。</p>
</blockquote>
<h2 id="u9006_u6CE2_u5170"><a href="#u9006_u6CE2_u5170" class="headerlink" title="逆波兰"></a>逆波兰</h2><p>只要努力 google 一下，我们就可以找到解决方法：</p>
<blockquote>
<p>使用「逆波兰表达式」。</p>
</blockquote>
<p>像我们平时使用的 <code>1 + 1</code> 就叫 <em>中缀表达式</em> 。而 <em>逆波兰</em>（<em>后缀表达式</em> ）则形如 <code>1 1 +</code>。</p>
<p>现在，我们的问题就变成了:</p>
<blockquote>
<p>怎样把「中缀表达式」转换成「逆波兰表达式」？</p>
</blockquote>
<h2 id="Tokenizer"><a href="#Tokenizer" class="headerlink" title="Tokenizer"></a>Tokenizer</h2><p>第一步，我们需要做的是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 假设我们的字符串形如：`<span class="number">1</span>+<span class="number">2</span>*<span class="number">3</span>-<span class="number">4</span>`</span><br><span class="line">// 那么就要把他转换成这样的一个数组：</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123; <span class="built_in">type</span>: <span class="string">'number'</span>, value: <span class="number">1</span> &#125;,</span><br><span class="line">  &#123; <span class="built_in">type</span>: <span class="string">'operator'</span>, value: <span class="string">'+'</span> &#125;,</span><br><span class="line">  &#123; <span class="built_in">type</span>: <span class="string">'number'</span>, value: <span class="number">2</span> &#125;,</span><br><span class="line">  ....</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><em>查看代码请点击 <a href="https://github.com/DrakeLeung/calc/blob/master/src/tokenizer.js" target="_blank" rel="external">tokenizer</a> 。</em></p>
<h2 id="toRPN"><a href="#toRPN" class="headerlink" title="toRPN"></a>toRPN</h2><p>第二步，我们要把得到的 tokens 转换成 <em>逆波兰</em> 形式。这个时候需要用到 <a href="/">shunting-yard</a> 算法。</p>
<p><em>查看代码请点击 <a href="https://github.com/DrakeLeung/calc/blob/master/src/toRPN.js" target="_blank" rel="external">toRPN</a> 。</em></p>
<h2 id="Calculator"><a href="#Calculator" class="headerlink" title="Calculator"></a>Calculator</h2><p>第三步，也是我们最后一步。</p>
<p>我们需要把创建一个 <strong>操作数栈</strong> ，如果是操作数的话，push 到栈里去；如果是操作符的话，把栈里的前两个操作数 pop 出来，计算他们和该操作符的结果。然后把结果 push 到栈里。重复之，直到遍历完所有的 tokens 。</p>
<p><em>查看代码请点击 <a href="https://github.com/DrakeLeung/calc/blob/master/src/index.js" target="_blank" rel="external">calculator</a> 。</em></p>
<h2 id="u62BD_u8C61_u8BED_u6CD5_u6811"><a href="#u62BD_u8C61_u8BED_u6CD5_u6811" class="headerlink" title="抽象语法树"></a>抽象语法树</h2><p>其实，我们还能做些更有趣的事情。比如，构建一棵 AST 。做法其实和第三步差不多。</p>
<ol>
<li>创建一个 <strong>操作数栈</strong></li>
<li>遍历 tokens</li>
<li>如果 token 为操作数，则 push 到栈里。</li>
<li>如果 token 为操作符，则把 栈里的两个操作数 pop 出来，与该操作符形成 AST 的一个节点，接着把该节点 push 到栈里去</li>
<li>重复之，直到遍历完 tokens</li>
</ol>
<p>有了 AST 之后，如果我们对其分别进行前序，中序，后序遍历的话，就可以得到 <strong>前缀表达式</strong> ，<strong>中缀表达式</strong> ，以及 <strong>后缀表达式</strong> 。</p>
<p><em>查看代码请点击 <a href="https://github.com/DrakeLeung/calc/blob/master/src/parser.js" target="_blank" rel="external">parser</a> 。</em></p>
<h2 id="u9879_u76EE_u6E90_u7801"><a href="#u9879_u76EE_u6E90_u7801" class="headerlink" title="项目源码"></a>项目源码</h2><p>所有代码可查看：<a href="https://github.com/DrakeLeung/calc" target="_blank" rel="external">https://github.com/DrakeLeung/calc</a></p>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="http://7xrcp8.com1.z0.glb.clouddn.com/avatar.png" alt="avatar" />
    <div class="grid-item">
      <p class="title"> ly你个c </p>
      <p class="subtitle"> You are the JavaScript in my HTML </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="DrakeLeung"
  href="https://twitter.com/intent/tweet?text=更多信息可查看 <a href="htt"
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'drakeleung';
  
  var disqus_url = 'http://drakeleung.github.io/blog/2016/07/14/a-mathematical-expressions-parser/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>

</body>
</html>
