<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Scope(3)-What Is Closure | 追客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css" type="text/css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
</head>

<body>
  <nav class="app-nav">
  
      
        <a class="active" href="/.">home</a>
        

      
  
      
        <a href="/archives">archive</a>
      
  
      
        <a href="/atom.xml">rss</a>
      
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2015/07/19/Scope-3-What-Is-Closure/">Scope(3)-What Is Closure</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">July 19 2015</p>
  </section>

  <section class="article-entry">
    <h2 id="What_is_Closure"><a href="#What_is_Closure" class="headerlink" title="What is Closure"></a>What is Closure</h2><p>什么是闭包呢？我们来下个定义吧。</p>
<blockquote>
<p>闭包就是函数可以访问他的lexical scope，即使他是在他的lexical scope外面执行的。</p>
</blockquote>
<p>先看个例子压压惊。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">bar</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(x);</span><br><span class="line">    &#125;</span><br><span class="line">    bar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo(); <span class="comment">// 42</span></span><br></pre></td></tr></table></figure>
<p>很自然而然地，上面例子输出的结果就是<code>42</code>。为什么呢？这其实就是作用域链的问题而已。<br><code>bar</code>函数要引用到<code>x</code>这个变量的值。于是就在自己的作用域找，找不到。于是向上找，然后在<code>foo</code>函数的作用域就找到了。</p>
<p>很显然，上面的例子是符合我们对闭包定义的前半部分，<strong>但是后半部分是不符合的</strong>。因为<code>bar</code>的lexical scope就是<code>foo</code>的作用域，而<code>bar</code>就是在<code>foo</code>的作用域里面被调用的。</p>
<h2 id="How_it_Works"><a href="#How_it_Works" class="headerlink" title="How it Works"></a>How it Works</h2><p>既然这样，我们就想办法让<code>bar</code>在<code>foo</code>的作用域外面执行。比如使用<code>return</code>.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> x = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(x);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bar;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> baz = foo();</span><br><span class="line">baz();</span><br></pre></td></tr></table></figure></p>
<p>在上面的例子中，其实<code>baz</code>就是<code>bar</code>，只是名字换了而已，内容还是没有改变的。那么好，现在，<code>bar</code>(也就是<code>baz</code>)并不是在他的lexical scope(<code>foo</code>‘s scope)被调用，而是在global scope。并且，<code>bar</code>还可以访问他的lexical scope里面的<code>x</code>。所以，你可以说，<strong>这就是闭包</strong>。</p>
<p>我们再来看1个例子:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">baz</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  fn();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> x = <span class="number">42</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(x);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  baz(bar);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo();</span><br></pre></td></tr></table></figure></p>
<p>同样地，上面的例子中，<code>bar</code>并没有在他的lexical scope(<code>foo</code>‘s scope)中执行，而在是<code>baz</code>里面执行。并且，<code>bar</code>还是可以访问他的lexical scope。因此，这个也是闭包！</p>
<h2 id="More_Examples"><a href="#More_Examples" class="headerlink" title="More Examples"></a>More Examples</h2><p>其实，闭包到处都是~</p>
<p>比如，一个定时器。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">timer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(msg);</span><br><span class="line">  &#125;, <span class="number">2</span> * <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line">wait(<span class="string">'I am also a closure example'</span>);</span><br></pre></td></tr></table></figure></p>
<p>2秒钟之后，浏览器引擎就会在全局中调用<code>timer</code>函数。也就是说，<code>timer</code>并没有在他的lexical scope(<code>wait</code>‘s scope)里面执行，但是他仍然可以访问<code>msg</code>。所以，这个也是一个闭包。</p>
<p>再比如，一个Event Handler.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">submit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> username = <span class="string">'Drake'</span>,</span><br><span class="line">    submitBtn = <span class="built_in">document</span>.querySelector(<span class="string">'button[type=submit]'</span>);</span><br><span class="line"></span><br><span class="line">  submitBtn.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(username);</span><br><span class="line">  &#125;, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Loops_and_Closure"><a href="#Loops_and_Closure" class="headerlink" title="Loops and Closure"></a>Loops and Closure</h2><p>当闭包出现在循环中的时候，就会很容易出现问题。举个例子，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">timer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面例子中，很出乎意料地输出了5个<code>5</code>。为什么呢？原因在于:</p>
<ol>
<li>在第一个<code>timer</code>函数执行之前，已经有5个<code>timer</code>函数定义好了。</li>
<li>当第一个<code>timer</code>执行时，他需要引用到<code>i</code>。</li>
<li>首先他在自己的作用域找，找不到。</li>
<li>于是向上找，因为JavaScript并没有block scope。所以向上的话就是global scope.</li>
<li>在global scope里面找到了<code>i</code>。此时<code>i</code>为<code>5</code>（因为已经循环了5次)</li>
</ol>
<p>是不是觉得少了点什么？如果<code>timer</code>在自己的作用域就可以找到<code>i</code>的话就好咯。或者，在中间加多一层作用域，而不用去到<code>global scope</code>里面找（因为他的<code>i</code>一定是为<code>5</code>的)</p>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>第一种，<code>timer</code>在自己的作用域就可以找到<code>i</code>。可以利用<code>forEach</code>等循环方法。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> aArray = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>];</span><br><span class="line"></span><br><span class="line">aArray.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item, index, array</span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">timer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(index);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>第二种，在中间新增一层作用域。常用的pattern就是使用IIFE。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">  (<span class="function"><span class="keyword">function</span>(<span class="params">j</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">timer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(j);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由于IIFE是立即调用的，所以每次调用的时候都传进了不同的实参。</p>
<ol>
<li>当<code>timer</code>要引用<code>i</code>的时候，现在自己的作用域里面找。找不到。</li>
<li>然后向上找，在IIFE里面找到了，也就是形参<code>j</code>。</li>
</ol>
<p>第三种利用<code>let</code>来创建block scope.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">timer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>let</code>劫持了<code>for</code>的作用域。每次循环，都会初始化一个新的<code>i</code>。</p>
<p><code>timer</code>在自己的作用域找不到<code>i</code>,向上找，在<code>for</code>里面找，哈，找到了。</p>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="http://7xrcp8.com1.z0.glb.clouddn.com/avatar.png" alt="avatar" />
    <div class="grid-item">
      <p class="title"> 追客 </p>
      <p class="subtitle"> You are the JavaScript in my HTML </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="DrakeLeung"
  href="https://twitter.com/intent/tweet?text= id="What_is_Closure"
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'drakeleung';
  
  var disqus_url = 'http://drakeleung.github.io/blog/2015/07/19/Scope-3-What-Is-Closure/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>

</body>
</html>
